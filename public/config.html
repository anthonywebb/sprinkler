<!DOCTYPE html>
<html>
<head>
<link rel=stylesheet type="text/css"
      href="/sprinkler.css" title="Sprinkler">
<script src="/sprinklerlib.js"></script>
<script>

var editing = null;

var countZoneShown = 0;
var countSeasonMonthlyShown = 0;
var countAdjustMonthlyShown = 0;
var countWeatherRefreshShown = 0;
var hardware = null;

var gui = new Object();

function saveConfig () {

   var form = document.forms;

   var newconfig = new Object();
   newconfig.on = editing.on;

   newconfig.webserver = new Object();
   newconfig.webserver.port = form.global.webport.value;
   newconfig.webserver.host = "127.0.0.1";

   newconfig.udp = new Object();
   newconfig.udp.port = form.global.udpport.value;

   if (form.global.location.value)
      newconfig.location = form.global.location.value;
   newconfig.zipcode = form.global.zipcode.value;
   newconfig.timezone = form.global.timezone.value;
   newconfig.production = form.global.production.checked;
   newconfig.raindelay = form.global.raindelay.checked;

   newconfig.event = new Object();
   newconfig.event.syslog = form.event.eventsyslog.checked;
   newconfig.event.cleanup = form.event.eventcleanup.value;

   newconfig.weather = new Object();
   newconfig.weather.enable = form.weather.weatherenable.checked;
   newconfig.weather.key = form.weather.weatherkey.value;
   newconfig.weather.raintrigger = form.weather.weatherrain.value;
   newconfig.weather.adjust = new Object();
   newconfig.weather.adjust.enable = form.weather.weatheradjustenable.checked;
   newconfig.weather.adjust.min = form.weather.weathermin.value;
   newconfig.weather.adjust.max = form.weather.weathermax.value;
   newconfig.weather.adjust.temperature = form.weather.weathertemp.value;
   newconfig.weather.adjust.humidity = form.weather.weatherhumid.value;
   newconfig.weather.adjust.sensitivity = form.weather.weathersens.value;
   if (editing.weather.refresh) {
      newconfig.weather.refresh = new Array();
      for (var i = 0; i < editing.weather.refresh.length; i++) {
         newconfig.weather.refresh[i] =
            form.weather["weatherrefresh_"+i].value;
      }
   }

   newconfig.wateringindex = new Object();
   newconfig.wateringindex.enable = form.waterindex.waterindexenable.checked;
   newconfig.wateringindex.provider = form.waterindex.waterindexprovider.value;
   newconfig.wateringindex.adjust = new Object();
   newconfig.wateringindex.adjust.min = form.waterindex.waterindexmin.value;
   newconfig.wateringindex.adjust.max = form.waterindex.waterindexmax.value;
   if (editing.wateringindex.refresh) {
      newconfig.wateringindex.refresh = new Array();
      for (var i = 0; i < editing.wateringindex.refresh.length; i++) {
         newconfig.wateringindex.refresh[i] =
            form.waterindex["waterindexrefresh_"+i].value;
      }
   }

   newconfig.zones = new Array();

   for (var i = 0; i < countZoneShown; i++) {
      var prefix = 'zone_'+i+'_';
      newconfig.zones[i] = new Object();
      newconfig.zones[i].name = form.zones[prefix+'name'].value;
      if (hardware.zones.pin) {
         newconfig.zones[i].pin = form.zones[prefix+'pin'].value;
         newconfig.zones[i].on = form.zones[prefix+'level'].value;
      }
      if (form.zones[prefix+'adjust'].value) {
         newconfig.zones[i].adjust = form.zones[prefix+'adjust'].value;
      }
      if (form.zones[prefix+'pulse'].value) {
         newconfig.zones[i].pulse = form.zones[prefix+'pulse'].value;
      }
      if (form.zones[prefix+'pause'].value) {
         newconfig.zones[i].pause = form.zones[prefix+'pause'].value;
      }
      if (form.zones[prefix+'master'].value) {
         newconfig.zones[i].master = form.zones[prefix+'master'].value;
      }
      if (form.zones[prefix+'manual'].checked) {
         newconfig.zones[i].manual = true;
      }
   }

   if (editing.programs) {
      newconfig.programs = new Array();

      for (var i = 0; i < editing.programs.length; i++) {
         var prefix = 'program_'+i+'_';
         newconfig.programs[i] = new Object();
         newconfig.programs[i].name = form.program[prefix+'name'].value;
         newconfig.programs[i].start = form.program[prefix+'start'].value;
         if (form.program[prefix+'date'].value)
            newconfig.programs[i].date = form.program[prefix+'date'].value;
         if (form.program[prefix+'season'].value)
            newconfig.programs[i].season = form.program[prefix+'season'].value;
         if (form.program[prefix+'append'].checked) {
            newconfig.programs[i].options = new Object();
            newconfig.programs[i].options.append = true;
         }
         newconfig.programs[i].active = form.program[prefix+'active'].checked;
         newconfig.programs[i].repeat = form.program[prefix+'repeat'].value;
         switch (newconfig.programs[i].repeat) {
         case 'weekly':
            newconfig.programs[i].days = new Array();
            for (var j = 0; j < 7; j++) {
               newconfig.programs[i].days[j] =
                  form.program[prefix+'days_'+j].checked;
            }
            break;
         case 'daily':
            newconfig.programs[i].interval =
               form.program[prefix+'interval'].value;
            break;
         }
         newconfig.programs[i].zones = new Array();
         for (var z = 0; z < editing.zones.length; z++) {
            if (form.program[prefix+'zone_'+z+'_seconds'] != undefined) {
               if (form.program[prefix+'zone_'+z+'_seconds'].value.length) {
                  var zi = newconfig.programs[i].zones.length;
                  newconfig.programs[i].zones[zi] = new Object();
                  newconfig.programs[i].zones[zi].zone = z;
                  newconfig.programs[i].zones[zi].seconds =
                     form.program[prefix+'zone_'+z+'_seconds'].value;
               }
            }
         }
      }
   }

   if (editing.calendars) {
      newconfig.calendars = new Array();

      for (var i = 0; i < editing.calendars.length; i++) {
         var prefix = 'calendar_'+i+'_';
         newconfig.calendars[i] = new Object();
         newconfig.calendars[i].name = form.calendar[prefix+'name'].value;
         newconfig.calendars[i].format = form.calendar[prefix+'format'].value;
         if (form.calendar[prefix+'disabled'].checked)
            newconfig.calendars[i].disabled = true;
         newconfig.calendars[i].source = form.calendar[prefix+'source'].value;
      }
   }

   if (editing.seasons) {
      newconfig.seasons = new Array();

      for (var i = 0; i < countSeasonMonthlyShown; i++) {
         var prefix = 'seasonmonthly_'+i+'_';
         newconfig.seasons[i] = new Object();
         newconfig.seasons[i].name = form.seasonmonthly[prefix+'name'].value;
         newconfig.seasons[i].monthly = new Array();
         for (var j = 0; j < 12; j++) {
            newconfig.seasons[i].monthly[j] = form.seasonmonthly[prefix+j].checked;
         }
      }
   }

   if (editing.adjust) {
      newconfig.adjust = new Array();

      for (var i = 0; i < countAdjustMonthlyShown; i++) {
         var prefix = 'adjustmonthly_'+i+'_';
         newconfig.adjust[i] = new Object();
         newconfig.adjust[i].name = form.adjustmonthly[prefix+'name'].value;
         newconfig.adjust[i].monthly = new Array();
         for (var j = 0; j < 12; j++) {
            newconfig.adjust[i].monthly[j] = form.adjustmonthly[prefix+j].value;
         }
      }
   }

   // console.log ("config = "+JSON.stringify(newconfig));
   sprinklerSaveConfig(newconfig);
}

function showInput (name, content) {
   var elements = document.getElementsByName (name);
   for (var i = 0; i < elements.length; i++) {
      if (content || (content === 0)) elements[i].value = ''+content;
   }
}

function showSelected (name, content) {
   var elements = document.getElementsByName (name);
   for (var i = 0; i < elements.length; i++) {
      var element = elements[i];
      for (var j = 0; j < element.options.length; j++) {
         if (element.options[j].value == content) {
            element.options[j].selected = true;
            break;
         }
      }
   }
}

function showCheckbox (name, content) {
   var elements = document.getElementsByName (name);
   for (var i = 0; i < elements.length; i++) {
      elements[i].checked = (content == true);
   }
}

function hideAll () {
   var elements = document.getElementsByClassName('hidable');
   for (var i = 0; i < elements.length; i++) {
      elements[i].style.display = 'none';
   }
}

function visible (name) {
   elements = document.getElementsByName(name);
   for (var i = 0; i < elements.length; i++) {
      if (elements[i].style.display === 'none') {
         elements[i].style.display = 'block';
      } else {
         elements[i].style.display = 'none';
      }
   }
}

function forceVisible (elements) {
   for (var k = 0; k < elements.length; k++) {
      elements[k].style.display = 'block';
   }
}

function showOneZone (zones, i, elements) {

   for (var k = 0; k < elements.length; k++) {
      var outer = document.createElement("tr");

      var prefix = 'zone_'+i+'_';

      var labelcolumn = document.createElement("td");
      var label = document.createElement("span");
      label.innerHTML = ''+i;
      labelcolumn.appendChild(label);
      outer.appendChild(labelcolumn);

      var namecolumn = document.createElement("td");
      var nameinput = document.createElement("input");
      nameinput.type = 'text';
      nameinput.name = prefix+'name';
      nameinput.value = zones[i].name;
      nameinput.placeholder = 'Zone name';
      namecolumn.appendChild(nameinput);
      outer.appendChild(namecolumn);

      if (hardware.zones.pin) {
         var pincolumn = document.createElement("td");
         var pininput = document.createElement("input");
         pininput.type = 'text';
         pininput.name = prefix+'pin';
         if (zones[i].pin)
            pininput.value = zones[i].pin;
         else
            pininput.value = '';
         pininput.placeholder = 'GPIO pin';
         pincolumn.appendChild(pininput);
         outer.appendChild(pincolumn);

         var levelcolumn = document.createElement("td");
         var levelselect = document.createElement("select");
         levelselect.name = prefix+'level';
         levelcolumn.appendChild(levelselect);
         outer.appendChild(levelcolumn);
         var levelhigh = document.createElement("option");
         levelhigh.value = 'HIGH';
         levelhigh.innerHTML = 'Active High';
         levelselect.appendChild(levelhigh);
         levellow = document.createElement("option");
         levellow.value = 'LOW';
         levellow.innerHTML = 'Active Low';
         levelselect.appendChild(levellow);
         if (zones[i].on === 'HIGH')
            levelhigh.selected = true;
         else
            levellow.selected = true;
      }

      var adjustcolumn = document.createElement("td");
      var adjustinput = document.createElement("input");
      adjustinput.type = 'text';
      adjustinput.name = prefix+'adjust';
      if (zones[i].adjust)
         adjustinput.value = zones[i].adjust;
      adjustinput.placeholder = 'Schedule name';
      adjustcolumn.appendChild(adjustinput);
      outer.appendChild(adjustcolumn);

      var pulsecolumn = document.createElement("td");
      var pulseinput = document.createElement("input");
      pulseinput.type = 'text';
      pulseinput.name = prefix+'pulse';
      if (zones[i].pulse)
         pulseinput.value = zones[i].pulse;
      pulseinput.placeholder = 'Seconds';
      pulsecolumn.appendChild(pulseinput);
      outer.appendChild(pulsecolumn);

      var pausecolumn = document.createElement("td");
      var pauseinput = document.createElement("input");
      pauseinput.type = 'text';
      pauseinput.name = prefix+'pause';
      if (zones[i].pause)
         pauseinput.value = zones[i].pause;
      pauseinput.placeholder = 'Seconds';
      pausecolumn.appendChild(pauseinput);
      outer.appendChild(pausecolumn);

      var mastercolumn = document.createElement("td");
      var masterinput = document.createElement("input");
      masterinput.type = 'text';
      masterinput.name = prefix+'master';
      if (zones[i].master)
         masterinput.value = zones[i].master;
      masterinput.placeholder = 'Index';
      mastercolumn.appendChild(masterinput);
      outer.appendChild(mastercolumn);

      var manualcolumn = document.createElement("td");
      var manualinput = document.createElement("input");
      manualinput.type = 'checkbox';
      manualinput.name = prefix+'manual';
      manualinput.checked = (zones[i].manual == true);
      manualcolumn.appendChild(manualinput);
      outer.appendChild(manualcolumn);

      elements[k].appendChild(outer);
   }
   if (i >= countZoneShown)
      countZoneShown = i+1;
}

function addZone () {

   if (! editing.zones) {
      editing.zones = new Array();
   }
   var i = editing.zones.length;
   editing.zones[i] = new Object();
   editing.zones[i].name = 'zone '+i;
   // No adjust (optional)
   // No manual (optional)

   var elements = document.getElementsByName('zonetable');
   showOneZone (editing.zones, i, elements);
   forceVisible(elements);
}

function showOneRefreshSchedule (weather, i, elements, name) {

   for (var k = 0; k < elements.length; k++) {
      var outer = document.createElement("tr");

      var timecolumn = document.createElement("td");
      var timeinput = document.createElement("input");
      timeinput.type = 'text';
      timeinput.size = 6;
      timeinput.name = name+'refresh_'+i;
      timeinput.value = weather.refresh[i];
      timeinput.placeholder = 'hh:mm';
      timecolumn.appendChild(timeinput);
      outer.appendChild(timecolumn);

      elements[k].appendChild(outer);
   }
}

function addRefreshSchedule (data, name) {

   if (! data.refresh) {
      data.refresh = new Array();
   }
   var i = data.refresh.length;
   data.refresh[i] = '';

   var elements = document.getElementsByName(name+'refreshtable');
   showOneRefreshSchedule (data, i, elements, name);
   forceVisible(elements);
}

function addWeatherRefresh () {

   if (! editing.weather) {
      editing.weather = new Object();
   }
   addRefreshSchedule (editing.weather, 'weather');
}

function addWaterIndexRefresh () {

   if (! editing.wateringindex) {
      editing.wateringindex = new Object();
   }
   addRefreshSchedule (editing.wateringindex, 'waterindex');
}

function showOneCalendar (calendars, i, elements) {

   for (var k = 0; k < elements.length; k++) {

      var outer = document.createElement("tr");

      var prefix = 'calendar_'+i+'_';

      var labelcolumn = document.createElement("td");
      var label = document.createElement("span");
      label.innerHTML = ''+i;
      labelcolumn.appendChild(label);
      outer.appendChild(labelcolumn);

      var namecolumn = document.createElement("td");
      var nameinput = document.createElement("input");
      nameinput.type = 'text';
      nameinput.name = prefix+'name';
      nameinput.value = calendars[i].name;
      nameinput.placeholder = 'Name';
      namecolumn.appendChild(nameinput);
      outer.appendChild(namecolumn);

      // For now only iCalendar is supported by the software,
      // so editing the format is not allowed.
      var formatcolumn = document.createElement("td");
      var formatinput = document.createElement("input");
      formatinput.type = 'text';
      formatinput.name = prefix+'format';
      formatinput.value = calendars[i].format;
      formatinput.disabled = true;
      formatcolumn.appendChild(formatinput);
      outer.appendChild(formatcolumn);

      var disabledcolumn = document.createElement("td");
      var disabledinput = document.createElement("input");
      disabledinput.type = 'checkbox';
      disabledinput.name = prefix+'disabled';
      disabledinput.checked = (calendars[i].disabled == true);
      disabledcolumn.appendChild(disabledinput);
      outer.appendChild(disabledcolumn);

      var sourcecolumn = document.createElement("td");
      var sourceinput = document.createElement("input");
      sourceinput.type = 'text';
      sourceinput.name = prefix+'source';
      sourceinput.style.width = '100%';
      sourceinput.value = calendars[i].source;
      sourceinput.placeholder = "URL";
      sourcecolumn.appendChild(sourceinput);
      outer.appendChild(sourcecolumn);

      elements[k].appendChild(outer);
   }
}

function addCalendar () {

   if (! editing.calendars) {
      editing.calendars = new Array();
   }
   var i = editing.calendars.length;
   editing.calendars[i] = new Object();
   editing.calendars[i].name = 'Calendar '+i;
   editing.calendars[i].format = 'iCalendar';
   editing.calendars[i].source = '';

   var elements = document.getElementsByName('calendartable');
   showOneCalendar (editing.calendars, i, elements);
   forceVisible(elements);
}

var toWeekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Satursday'];

function showOneProgramString (programs, i, label, name, format, size, value) {

   var program = programs[i];

   var line = document.createElement("tr");

   var labelcolumn = document.createElement("td");
   var labelitem = document.createElement("span");
   labelitem.innerHTML = label+':';
   labelcolumn.appendChild(labelitem);
   line.appendChild(labelcolumn);

   var valuecolumn = document.createElement("td");
   var valueentry = document.createElement("input");
   valueentry.type = 'text';
   valueentry.name = 'program_'+i+'_'+name;
   valueentry.size = size;
   if (value) {
      valueentry.value = value;
   }
   valueentry.placeholder = format;
   valuecolumn.appendChild(valueentry);
   line.appendChild(valuecolumn);

   return line;
}

function showOneProgramFlag (programs, i, label, name, value) {

   var program = programs[i];

   var parameterline = document.createElement("tr");

   var column = document.createElement("td");
   parameterline.appendChild(column);

   column = document.createElement("td");
   var checkbox = document.createElement("input");
   checkbox.type = 'checkbox';
   checkbox.name = 'program_'+i+'_'+name;
   checkbox.value = value;
   checkbox.checked = value;
   column.appendChild(checkbox);
   var labelitem = document.createElement("span");
   labelitem.innerHTML = label;
   column.appendChild(labelitem);
   parameterline.appendChild(column);

   return parameterline;
}

function showOneProgramRadio (programs, i, label, name, value) {

   var program = programs[i];

   var parameterline = document.createElement("tr");

   var column = document.createElement("td");
   parameterline.appendChild(column);

   column = document.createElement("td");

   var checkbox = document.createElement("input");
   checkbox.type = 'radio';
   checkbox.name = 'program_'+i+'_'+name;
   checkbox.onchange = function () {
      switch (editing.programs[i].repeat) {
      case 'daily':
         gui.programs[i].weekly.style.display = 'none';
         gui.programs[i].daily.style.display = 'block';
         break;
      case 'weekly':
         gui.programs[i].weekly.style.display = 'block';
         gui.programs[i].daily.style.display = 'none';
         break;
      default:
         gui.programs[i].weekly.style.display = 'none';
         gui.programs[i].daily.style.display = 'none';
      }
   }
   checkbox.checked = (program[name] == value);
   checkbox.value = value;
   column.appendChild(checkbox);

   var labelitem = document.createElement("span");
   labelitem.innerHTML = label;
   column.appendChild(labelitem);

   parameterline.appendChild(column);

   return parameterline;
}

function showOneProgram (programs, i, elements) {

   var program = programs[i];
   var prefix = 'program_'+i+'_';

   // Make sure that the days array has the correct size.
   if (program.days) {
     for (var j = program.days.length; j < 7; j++) {
        program.days[j] = false;
     }
   }
   for (var k = 0; k < elements.length; k++) {
      var programshell = document.createElement("tr");
      var programshell2 = document.createElement("td");
      var programtable = document.createElement("table");
      programtable.className = 'programdata';

      var programline = document.createElement("tr");
      var header = document.createElement("th");
      header.innerHTML = 'Parameters';
      programline.appendChild(header);
      header = document.createElement("th");
      header.innerHTML = 'Zones duration';
      programline.appendChild(header);
      programtable.appendChild(programline);

      programline = document.createElement("tr");

      var parameterscolumn = document.createElement("td");
      parameterscolumn.style.verticalAlign = 'top';
      var parameterstable = document.createElement("table");
      parameterstable.width = '100%';

      parameterstable.appendChild
         (showOneProgramFlag (programs, i, 'Active', 'active', program.active));
      var append = false;
      if (program.options) append = program.options.append;
      parameterstable.appendChild
         (showOneProgramFlag (programs, i, 'Append', 'append', append));
      parameterstable.appendChild
         (showOneProgramString (programs, i, 'Name', 'name', '', 16, program.name));
      parameterstable.appendChild
         (showOneProgramString (programs, i, 'Season', 'season', '', 16, program.season));
      parameterstable.appendChild
         (showOneProgramString (programs, i, 'Start time', 'start', 'hh:mm', 10, program.start));
      parameterstable.appendChild
         (showOneProgramString (programs, i, 'Start date', 'date', 'yyyymmdd', 10, program.date));

      parameterstable.appendChild
         (showOneProgramRadio (programs, i, 'Daily', 'repeat', 'daily'));
      parameterstable.appendChild
         (showOneProgramRadio (programs, i, 'Weekly', 'repeat', 'weekly'));

      parameterscolumn.appendChild(parameterstable);
      parameterscolumn.appendChild(document.createElement("br"));

      if (! gui.programs) {
         gui.programs = new Array();
      }
      gui.programs[i] = new Object();

      var weekly = document.createElement("table");
      weekly.name = 'program_'+i+'_weekly';
      weekly.style.display = 'none';
      gui.programs[i].weekly = weekly;
      weekly.width = '100%';
      if (program.days) {
         for (var d = 0; d < 7; d++) {
            weekly.appendChild (showOneProgramFlag (programs, i, toWeekDays[d], 'days_'+d, program.days[d]));
         }
      } else {
         for (var d = 0; d < 7; d++) {
            weekly.appendChild (showOneProgramFlag (programs, i, toWeekDays[d], 'days_'+d, true));
         }
      }
      parameterscolumn.appendChild(weekly);

      var daily = document.createElement('table');
      daily.style.display = 'none';
      daily.width = '100%';
      gui.programs[i].daily = daily;
      var dailylabel = document.createElement('span');
      dailylabel.innerHTML = 'Interval: ';
      daily.appendChild(dailylabel);
      var dailyvalue = document.createElement('input');
      dailyvalue.type = 'text';
      dailyvalue.name = prefix+'interval';
      dailyvalue.size = 6;
      if (program.interval) {
         dailyvalue.value = program.interval;
      }
      dailyvalue.placeholder = 'Number';
      daily.appendChild(dailyvalue);
      parameterscolumn.appendChild(daily);

      switch (program.repeat) {
      case 'daily':
         daily.style.display = 'block';
         break;
      case 'weekly':
         weekly.style.display = 'block';
         break;
      }

      programline.appendChild(parameterscolumn);

      var zonecolumn = document.createElement("td");
      zonecolumn.style.verticalAlign = 'top';
      var zonetable = document.createElement("table");

      for (var d = 0; d < program.zones.length; d++) {
         var zoneline = document.createElement('tr');
         zonetable.appendChild
            (showOneProgramString (program.zones, i, 'Zone '+program.zones[d].zone, 'zone_'+program.zones[d].zone+'_seconds', 'Seconds', 6, program.zones[d].seconds));
      }

      zonecolumn.appendChild(zonetable);
      programline.appendChild(zonecolumn);

      programtable.appendChild(programline);
      programshell2.appendChild(programtable);
      programshell.appendChild(programshell2);

      elements[k].appendChild(programshell);
   }
}

function addProgram () {
   if (! editing.programs) {
      editing.programs = new Array();
   }
   var i = editing.programs.length;
   editing.programs[i] = new Object();
   editing.programs[i].active = true;
   editing.programs[i].repeat = 'weekly';
   editing.programs[i].name = '#'+i;
   editing.programs[i].start = '';
   editing.programs[i].days = new Array(true, true, true, true, true, true, true);
   editing.programs[i].interval = 1;
   editing.programs[i].zones = new Array();
   for (var z = 0; z < editing.zones.length; z++) {
      editing.programs[i].zones[z] = new Object();
      editing.programs[i].zones[z].zone = z;
      editing.programs[i].zones[z].seconds = '';
   }

   var elements = document.getElementsByName('programtable');
   showOneProgram (editing.programs, i, elements);
   forceVisible(elements);
}

function showOneSeasonMonthly (seasons, i, elements) {
   for (var k = 0; k < elements.length; k++) {
      var prefix = 'seasonmonthly_'+i+'_';
      var outer = document.createElement("tr");
      var column = document.createElement("td");
      var input = document.createElement("input");
      input.type = 'text';
      input.name = prefix+'name';
      input.value = seasons[i].name;
      input.placeholder = 'Name';
      column.appendChild(input);
      outer.appendChild(column);
      for (var j = 0; j < 12; j++) {
         column = document.createElement("td");
         input = document.createElement("input");
         input.type = 'checkbox';
         input.name = prefix+j;
         input.checked = (seasons[i].monthly[j] == true);
         column.appendChild(input);
         outer.appendChild(column);
      }
      elements[k].appendChild(outer);
   }
   if (i >= countSeasonMonthlyShown)
      countSeasonMonthlyShown = i+1;
}

function addSeasonMonthly () {

   var name = 'Unnamed';

   if (! editing.seasons) {
      editing.seasons = new Array();
   }

   var i = editing.seasons.length;
   editing.seasons[i] = new Object();
   editing.seasons[i].name = '';
   editing.seasons[i].monthly = new Array();
   for (var j = 0; j < 12; j++) {
      editing.seasons[i].monthly[j] = false;
   }

   var elements = document.getElementsByName('seasonmonthlytable');
   showOneSeasonMonthly (editing.seasons, i, elements);
   forceVisible(elements);
}

function showOneAdjustMonthly (adjust, i, elements) {
   for (var k = 0; k < elements.length; k++) {
      var prefix = 'adjustmonthly_'+i+'_';
      var outer = document.createElement("tr");
      var column = document.createElement("td");
      var input = document.createElement("input");
      input.type = 'text';
      input.name = prefix+'name';
      input.value = adjust[i].name;
      input.placeholder = 'Name';
      column.appendChild(input);
      outer.appendChild(column);
      for (var j = 0; j < 12; j++) {
         column = document.createElement("td");
         input = document.createElement("input");
         input.size = 3;
         input.type = 'text';
         input.name = prefix+j;
         input.inputmode = 'numeric';
         input.placeholder = '%';
         input.value = adjust[i].monthly[j];
         column.appendChild(input);
         outer.appendChild(column);
      }
      elements[k].appendChild(outer);
   }
   if (i >= countAdjustMonthlyShown)
      countAdjustMonthlyShown = i+1;
}

function addAdjustMonthly () {

   if (! editing.adjust) {
      editing.adjust = new Array();
   }

   var i = editing.adjust.length;
   editing.adjust[i] = new Object();
   editing.adjust[i].name = '';
   editing.adjust[i].monthly = new Array();
   for (var j = 0; j < 12; j++) {
      editing.adjust[i].monthly[j] = 100;
   }

   var elements = document.getElementsByName('adjustmonthlytable');
   showOneAdjustMonthly (editing.adjust, i, elements);
   forceVisible(elements);
}

window.onload = function() {

   function showExistingZones (zones) {

      if (! zones) return;
      var elements = document.getElementsByName('zonetable');

      for (var k = 0; k < elements.length; k++) {

         var titleline = document.createElement("tr");

         var titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Index';
         titleline.appendChild(titlecolumn);
         titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Name';
         titleline.appendChild(titlecolumn);
         if (hardware.zones.pin) {
            titlecolumn = document.createElement("th");
            titlecolumn.innerHTML = 'GPIO';
            titleline.appendChild(titlecolumn);

            titlecolumn = document.createElement("th");
            titlecolumn.innerHTML = 'Level';
            titleline.appendChild(titlecolumn);
         }
         titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Adjustment';
         titleline.appendChild(titlecolumn);
         titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Pulse';
         titleline.appendChild(titlecolumn);
         titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Pause';
         titleline.appendChild(titlecolumn);
         titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Master';
         titleline.appendChild(titlecolumn);
         titlecolumn = document.createElement("th");
         titlecolumn.innerHTML = 'Manual';
         titleline.appendChild(titlecolumn);

         elements[k].appendChild(titleline);
      }

      for (var i = 0; i < zones.length; i++) {
         showOneZone (zones, i, elements);
      }
   }

   function showExistingCalendars (calendars) {
      if (! calendars) return;
      var elements = document.getElementsByName('calendartable');
      for (var i = 0; i < calendars.length; i++) {
         showOneCalendar (calendars, i, elements);
      }
   }

   function showExistingPrograms (programs) {
      if (! programs) return;
      var elements = document.getElementsByName('programtable');
      for (var i = 0; i < programs.length; i++) {
         var zones = new Array();
         for (var z = 0; z < editing.zones.length; z++) {
            zones[z] = new Object();
            zones[z].zone = z;
            zones[z].seconds = '';
         }
         for (var z = 0; z < programs[i].zones.length; z++) {
            zones[programs[i].zones[z].zone].seconds = 
               programs[i].zones[z].seconds;
         }
         programs[i].zones = zones;
         showOneProgram (programs, i, elements);
      }
   }

   function showExistingAdjust (adjust) {
      if (! adjust) return;
      var elements = document.getElementsByName('adjustmonthlytable');
      for (var i = 0; i < adjust.length; i++) {
         if (adjust[i].monthly)
            showOneAdjustMonthly (adjust, i, elements);
      }
   }

   function showExistingSeasons (seasons) {
      if (! seasons) return;
      var elements = document.getElementsByName('seasonmonthlytable');
      for (var i = 0; i < seasons.length; i++) {
         if (seasons[i].monthly)
            showOneSeasonMonthly (seasons, i, elements);
      }
   }

   function showExistingRefreshSchedule (data, name) {
      if (! data) return;
      if (data.refresh) {
         var elements = document.getElementsByName(name+'refreshtable');
         for (var i = 0; i < data.refresh.length; i++) {
            showOneRefreshSchedule (data, i, elements, name);
         }
      }
   }

   sprinklerHardwareInfo (function (received) {
      hardware = received;

      sprinklerConfig (function (config) {
         editing = config;
         showInput ("webport", config.webserver.port);
         showInput ("udpport", config.udp.port);
         showInput ("location", config.location);
         showInput ("zipcode", config.zipcode);
         showInput ("timezone", config.timezone);
         showCheckbox ("production", config.production);

         showExistingZones (config.zones);
         showExistingPrograms (config.programs);
         showExistingSeasons (config.seasons);
         showExistingAdjust (config.adjust);
         showExistingCalendars (config.calendars);
         showExistingRefreshSchedule (config.weather, 'weather');
         showExistingRefreshSchedule (config.wateringindex, 'waterindex');

         if (! config.event) {
            config.event = new Object();
            if (config.syslog !== undefined) {
               config.event.syslog = config.syslog;
               delete config.syslog;
            }
         }
         showInput ("eventcleanup", config.event.cleanup);
         showCheckbox ("eventsyslog", config.event.syslog);

         if (config.weather) {
            showCheckbox ("weatherenable", config.weather.enable);
            if (config.weather.adjust) {
               showCheckbox ("weatheradjustenable", config.weather.adjust.enable);
               showInput ("weathermin", config.weather.adjust.min);
               showInput ("weathermax", config.weather.adjust.max);
               showInput ("weathertemp", config.weather.adjust.temperature);
               showInput ("weatherhumid", config.weather.adjust.humidity);
               showInput ("weathersens", config.weather.adjust.sensitivity);
            }
            showInput ("weatherkey", config.weather.key);
            showInput ("weatherrain", config.weather.raintrigger);
         }
         if (config.wateringindex) {
            showCheckbox ("waterindexenable", config.wateringindex.enable);
            if (config.wateringindex.provider) {
               showSelected ("waterindexprovider",
                             config.wateringindex.provider);
            } else {
               showSelected ("waterindexprovider", 'waterdex');
            }
            if (config.wateringindex.adjust) {
               showInput ("waterindexmin", config.wateringindex.adjust.min);
               showInput ("waterindexmax", config.wateringindex.adjust.max);
            }
         }
      });
   });

   hideAll();
};
</script>
<head>
   <title></title>
</head>
<body class="sprkrtext">
   <div class="sprkrbuttons"><button class="configactionbutton" onclick="saveConfig()">Save</button></div>
   <br>
   <button class="configbutton" onclick="visible('configglobal')">Global Parameters</button>
   <br>
   <form name="global">
   <div name="configglobal" class="hidable" display="none">
     <table>
        <tr>
           <td>Web Port:</td>
           <td><input type="text" size="5" name="webport" placeholder="Port number"></td>
        </tr>
        <tr>
           <td>UDP Port:</td>
           <td><input type="text" size="5" name="udpport" placeholder="Port number"></td>
        </tr>
        <tr>
           <td>Location:</td>
           <td><input type="text" size="30" name="location" placeholder="Name"></td>
        </tr>
        <tr>
           <td>Zip Code:</td>
           <td><input type="text" size="7" name="zipcode"></td>
        </tr>
        <tr>
           <td>Time Zone:</td>
           <td><input type="text" size="30" name="timezone"></td>
        </tr>
        <tr>
           <td></td>
           <td><input type="checkbox" name="production"> Production mode</td>
        </tr>
        <tr>
           <td></td>
           <td><input type="checkbox" name="raindelay"> Allow rain delay</td>
        </tr>
     </table>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addZone()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configzone')">Zones</button>
   <br>
   <form name="zones">
   <div name="configzone" class="hidable" display="none">
     <table name="zonetable">
     </table>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addProgram()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configprogram')">Programs</button>
   <br>
   <form name="program">
   <div name="configprogram" class="hidable" display="none">
     <table class="programtable" name="programtable">
     </table>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addCalendar()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configcalendar')">Calendars</button>
   <br>
   <form name="calendar">
   <div name="configcalendar" class="hidable" display="none">
     <table name="calendartable" width="100%">
     <tr>
        <th width="5%">Index</th>
        <th width="15%">Name</th>
        <th width="15%">Format</th>
        <th width="5%">Disabled</th>
        <th width="60%">Source</th>
     </tr>
     </table>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addSeasonMonthly()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configseasonmonthly')">Seasons</button>
   <br>
   <form name="seasonmonthly">
   <div name="configseasonmonthly" class="hidable" display="none">
     <table name="seasonmonthlytable">
        <tr>
        <th>Season</th>
        <th>January</th>
        <th>February</th>
        <th>March</th>
        <th>April</th>
        <th>May</th>
        <th>June</th>
        <th>July</th>
        <th>August</th>
        <th>September</th>
        <th>October</th>
        <th>November</th>
        <th>December</th>
        </tr>
     </table>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addAdjustMonthly()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configadjustmonthly')">Monthly adjustment</button>
   <br>
   <form name="adjustmonthly">
   <div name="configadjustmonthly" class="hidable" display="none">
     <table name="adjustmonthlytable">
        <tr>
        <th>Schedule</th>
        <th>Jan</th>
        <th>Feb</th>
        <th>Mar</th>
        <th>Apr</th>
        <th>May</th>
        <th>Jun</th>
        <th>Jul</th>
        <th>Aug</th>
        <th>Sep</th>
        <th>Oct</th>
        <th>Nov</th>
        <th>Dec</th>
        </tr>
     </table>
   </div>
   </form>
   <br>
   <button class="configbutton" onclick="visible('configevent')">Events</button>
   <br>
   <form name="event">
   <div name="configevent" class="hidable" display="none">
      Cleanup events older than <input type="text" size="3" name="eventcleanup"> days.
      <br>
      <input type="checkbox" name="eventsyslog"> Use syslog</input>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addWeatherRefresh()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configweather')">Weather Underground Service</button>
   <br>
   <form name="weather">
   <div name="configweather" class="hidable" display="none">
     <table>
        <tr>
           <td></td>
           <td><input type="checkbox" name="weatherenable"> Query weather conditions</td>
        </tr>
        <tr>
           <td>Key:</td>
           <td><input type="text" size="16" name="weatherkey" placeholder="Hexadecimal"></td>
        </tr>
        <tr>
           <td style="vertical-align:top">Refresh times:</td>
           <td>
              <table name="weatherrefreshtable"></table>
           </td>
        </tr>
        <tr>
           <td>Rain delay trigger:</td>
           <td><input type="text" name="weatherrain" placeholder="Inches"></td>
        </tr>
        <tr>
           <td></td>
           <td><input type="checkbox" name="weatheradjustenable"> Allow adjustments based on weather conditions</td>
        </tr>
        <tr>
           <td>Minimal adjustment:</td>
           <td><input type="text" size="3" name="weathermin" placeholder="%"></td>
        </tr>
        <tr>
           <td>Maximal adjustment:</td>
           <td><input type="text" size="3" name="weathermax" placeholder="%"></td>
        </tr>
        <tr>
           <td>Base temperature:</td>
           <td><input type="text" name="weathertemp" placeholder="Farenheit"></td>
        </tr>
        <tr>
           <td>Base humidity:</td>
           <td><input type="text" name="weatherhumid" placeholder="%"></td>
        </tr>
        <tr>
           <td>Sensitivity:</td>
           <td><input type="text" name="weathersens" placeholder="%"></td>
        </tr>
     </table>
   </div>
   </form>
   <br>
   <button class="addbutton" onclick="addWaterIndexRefresh()">Add</button>
   <button class="configbuttonwithadd" onclick="visible('configwaterindex')">Watering Index Service</button>
   <br>
   <form name="waterindex">
   <div name="configwaterindex" class="hidable" display="none">
     <table>
        <tr>
           <td></td>
           <td><input type="checkbox" name="waterindexenable"> Allow adjustments based on watering index</td>
        </tr>
        <tr>
           <td>Provider:</td>
           <td>
              <select name="waterindexprovider">
                 <option value="waterdex" selected>Waterdex.com</option> 
                 <option value="mwdsocal">Metropolitan Water District of Southern California</option>
              </select>
           </td>
        </tr>
        <tr>
           <td style="vertical-align:top">Refresh times:</td>
           <td>
              <table name="waterindexrefreshtable"></table>
           </td>
        </tr>
        <tr>
           <td>Minimal adjustment:</td>
           <td><input type="text" size="3" name="waterindexmin" placeholder="%"></td>
        </tr>
        <tr>
           <td>Maximal adjustment:</td>
           <td><input type="text" size="3" name="waterindexmax" placeholder="%"></td>
        </tr>
     </table>
   </form>
   </div>
   <br>
   <div class="sprkrbuttons"><button class="configactionbutton" onclick="saveConfig()">Save</button></div>
</body>
</html>

